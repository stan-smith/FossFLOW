<!-- 4952c9d5-08a0-42ae-bf15-798caa46984f f5eb3df3-62c4-4b43-b25f-2de2d23932ec -->
## Context-Aware AI Helper Sidebar Plan

### Goal

Build a **chat-style, context-aware AI helper sidebar** inside the FossFLOW editor that talks to the existing backend endpoint `POST /api/ai/query` (which in turn calls LightRAG’s `query/stream` API). The helper should send **rich diagram structure (nodes, edges, metadata)** as context so LightRAG can reason about the current diagram.

### Scope & UX Decisions

- **Placement**: Collapsible **right-hand sidebar** on the main editor page (`packages/fossflow-app/src/EditorPage.tsx` / `App.tsx`), visible only when the editor is active.
- **Interaction style**: **Chat thread** per diagram:
- Messages alternate between **User** and **AI**.
- Scoped to the currently open diagram; when the diagram changes, start a fresh thread.
- **Context depth**: Start with **full structure**:
- Extract nodes, edges, and basic metadata from the current diagram `Model`.
- Serialize into a compact JSON or text summary that we pass as `diagramContext` in `AiQueryRequest`.

### High-Level Steps

1. **Identify and tap into editor diagram state**

- Review [`packages/fossflow-app/src/EditorPage.tsx`](/Volumes/Data/Software%20Development/TypeScript/FossFLOW/packages/fossflow-app/src/EditorPage.tsx) and related components/hooks (e.g. `usePersistedDiagram.ts`) to see how the **current diagram model** is loaded, stored, and updated.
- Decide on a minimal shape to pass into the AI helper component (e.g. `{ diagramId, model }`).

2. **Design context extraction utility**

- Implement a small, pure helper (e.g. `buildDiagramContext(model: Model, id?: string)`) in a shared place such as [`packages/fossflow-app/src/diagramUtils.ts`](/Volumes/Data/Software%20Development/TypeScript/FossFLOW/packages/fossflow-app/src/diagramUtils.ts) or a new file.
- Responsibilities:
 - Extract key fields: nodes/items, connectors/edges, and diagram-level metadata (name/title if present).
 - Create a structured object compatible with `AiDiagramContext` **plus** optional `nodes` and `edges` arrays or a `structure` field.
 - Ensure the result is reasonably compact (e.g. avoid including very large blobs or binary content).

3. **Create AI helper UI component**

- Add a new React component, e.g. `AiHelperSidebar.tsx` under `packages/fossflow-app/src/components/`.
- Responsibilities:
 - Render a **collapsible right-hand panel** with:
 - Header ("AI Helper" with an icon).
 - Scrollable chat history area.
 - Text input + send button for the user’s query.
 - Maintain local state:
 - `messages`: array of `{ id, role: 'user' | 'assistant', content: string, createdAt }`.
 - `inputValue`: current text in the input.
 - `isLoading`: whether a request is in flight.
 - Optional `error` string for showing last failure.
 - Call the frontend service `queryAi` from `services/aiService.ts` with:
 - `query: inputValue`.
 - `diagramContext`: built from current diagram model via `buildDiagramContext`.
 - Append user + assistant messages to the thread upon success; show an error message on failure.

4. **Integrate the sidebar into the editor layout**

- Update `EditorPage.tsx` to:
 - Import and render `AiHelperSidebar` alongside the existing editor canvas.
 - Pass down the current `diagramId` and `model` (or equivalent) into the sidebar.
 - Add a simple toggle (button) to show/hide the sidebar, ensuring it does not break existing layout or functionality.
- Make sure the sidebar **does not interfere with core editing** (respect existing CSS and flex/grid layout).

5. **Wire full-structure diagram context into AI requests**

- Within `AiHelperSidebar`, before calling `queryAi`, build the context object:
 - Include `diagramId`, diagram name/title (if available), and structured `nodes` / `edges` derived from `Model`.
- Pass this as `diagramContext` in `AiQueryRequest` so that the backend receives the full structure and forwards it to LightRAG.

6. **Polish UX & resilience**

- Add basic loading state in the UI (spinner or "Thinking…" message while waiting for AI response).
- Disable the send button while a request is in flight or when the input is empty.
- Handle backend errors gracefully (show a compact error message in the chat instead of breaking the UI).
- Keep per-diagram chat: clear messages when the diagram id changes.

7. **Validation & manual testing**

- Run `npm run dev` from the repo root.
- Open the editor in the browser and verify:
 - Sidebar toggles correctly and does not disturb canvas interactions.
 - Submitting a question with a non-empty diagram sends a request to `/api/ai/query` with `diagramContext` populated.
 - Successful responses appear as assistant messages.
 - Network failures or LightRAG issues produce readable inline errors.

### Notes

- All user-visible strings in the new UI should be ready for i18n later (wrap in a simple helper or keep them centralized so they can be wired to existing i18n files).
- The initial implementation **does not** stream partial responses to the frontend; it waits for the aggregated `answer` from the backend, which already uses LightRAG’s `query/stream` under the hood.
- No changes are needed to the backend contract; we only consume the existing `/api/ai/query` endpoint.

### To-dos

- [ ] Review `EditorPage.tsx`, `App.tsx`, and related hooks to understand how the current diagram model and id are managed, so they can be passed into an AI helper sidebar.
- [ ] Implement a helper that converts the current diagram `Model` (and optional id) into a structured `diagramContext` object suitable for LightRAG (including nodes/edges).
- [ ] Create an `AiHelperSidebar` React component that renders a chat-style UI, manages local message state, and calls `queryAi` with diagram context.
- [ ] Embed the AI helper sidebar into the editor layout, pass the current diagram model/id into it, and add a non-intrusive toggle to show/hide it.
- [ ] Polish loading states, error display, and per-diagram chat reset behavior for the AI helper sidebar.
- [ ] Manually test the AI helper sidebar end-to-end with different diagrams, ensuring requests hit `/api/ai/query` with rich `diagramContext` and that failures are handled gracefully.